---
title: "Diamonds"
author: "rjhj"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Diamond paradox

How can there be a negative correlation between the quality of the cut of a diamond and its price? This work explains this fascinating and educational puzzle.

Data set

Diamonds is a famous training data set with almost 54,000 observations. It comes with ggplot2, which is a part of tidyverse.

In this work I'll be using tidyverse techniques and philosophies mentioned in the "R for Data Science" book by Hadley Wickham (<https://r4ds.had.co.nz/>).

### 1. Preparation

```{r}
library(tidyverse)

cut_colors = c("#C76E32", "#A8A846", "#46A846",
               "#3584B8", "#555599")
```

Price of diamonds in this data set is capped at around \$18,000. Here are the top 3 most valuable for each quality of cut. The numbers are very similar.

```{r}
diamonds |>
  group_by(cut) |>
  slice_max(order_by = price, n = 3)
```

This ceiling can hide the real connection between the variables, so in analysis I'm going filter out some of the biggest diamonds (\>= 1.75). Ceiling will still affect the results, but at least a little bit less.

```{r}
d <- diamonds |>
  filter(carat < 1.75)

paste("Only", nrow(diamonds) - nrow(d), "rows were removed.")

```

```{r}
d |>
  group_by(cut) |>
  slice_max(order_by = price, n = 3)
```

## 2. Paradox

How does the quality of the cut affect the price of diamonds?

```{r}
ggplot(d, aes(price, after_stat(density), colour = cut)) +
  geom_freqpoly(binwidth = 500, size = 2) +
  scale_color_manual(values = cut_colors) +
  labs(title = "Surprise: Lower quality cut diamonds are more valuable?",
       caption = "The area under each curve is one.")
```


```{r}
ggplot(d, mapping = aes(x = price, fill = cut))+
  geom_boxplot(aes(y = cut), alpha = 0.7) +
  scale_fill_manual(values = cut_colors) +
  labs(title = "Another plot showing that fair diamonds are more valuable than the ideal")
```

## 3. Explanation

Lower quality cuts being more valuable can be explained by two other correlations.

```{r}
ggplot(d, aes(x = carat, y = after_stat(density))) +
  geom_freqpoly(aes(colour = cut), size = 2, bins = 20) +
  scale_color_manual(values = cut_colors) +
  labs(title = "Explanation 1:",
       subtitle= "Diamonds with lower quality cuts seem to be bigger",
       caption = "The area under each curve is one.")
```

```{r}
ggplot(d, aes(x = carat, y = price)) + 
  geom_boxplot(aes(group = cut_width(carat, 0.1)), alpha = 0.5) +
  labs(title = "Explanation 2:",
       subtitle= "Size and price are strongly correlated",
       caption = "")
```

Let's explore the relationship between carat and price more.

## 4.Relationships between size and price

```{r}
ggplot(d, aes(carat, price)) +
  geom_bin2d() +
  scale_fill_continuous(type = "viridis") +
  labs(title = "Relationship seems to be exponential")
```

```{r}
ggplot(d, aes(carat, price)) +
  geom_bin2d() +
  scale_fill_continuous(type = "viridis") +
  geom_smooth(formula = y ~ x, method = "lm", color = "white") +
  scale_x_log10() + 
  scale_y_log10() +
  labs(title = "Logarithmic scale fits the data well")
```

r^2^:

```{r}
model <- lm(log(price) ~ log(carat), d) 
paste0("Trying to fit linear model to the unmodified data gives R-squared of ",
      round(summary(lm(price ~ carat, d))$r.squared, 2),
      ", but the logarithmic data gives ",
      round(summary(model)$r.squared, 2),
      ".")
```

## 5. Addin residuals

Let's add a new column for residuals.

```{r}
d |>
  lm(model, data = _) |>
  add_residuals(d, model = _) -> d
```

Residuals here tell the difference between what the linear regression model
predicted and its actual value.

```{r}
slope = summary(model)$coefficients[2]
intercept = summary(model)$coefficients[1]
paste0("The formula given by linear model gives is ",
       round(slope, 2),
       " * log(carat) + ",
       round(intercept, 2),
       " = log(price). It can explain ",
       round(summary(model)$r.squared[1]*100),
       " % of the variation in a diamond's price.")
```
Here is a demonstration that shows that the formula works well when the residuals are low.
```{r}
d |>
  slice_min(abs(resid), n = 3, with_ties = FALSE) -> low_resids

d |>
  slice_max(abs(resid), n = 3, with_ties = FALSE) -> high_resids

different_resids <- bind_rows(low_resids, high_resids) |>
  arrange(abs(resid)) |>
  mutate(predicted_price = round(exp(slope * log(carat) + intercept))) |>
  mutate(resid = round(resid, 5)) |>
  select(carat:clarity, resid, price, predicted_price)

different_resids
  
```

For the bottom three diamonds the carat explain quite little of their price. For the top three it does great job.

## 6. Solving the paradox

Residuals represents the price where the effect of diamond's size has been removed.

Let's look at the original mystery plots where instead of comparing cut to price, 
we do the comparison against residuals.

```{r}
ggplot(d, aes(resid, after_stat(density), colour = cut)) +
  geom_freqpoly(bins = 30, size = 2) +
  scale_color_manual(values = cut_colors) +
  labs(title = "Paradox solved: Better cuts are more valuable",
       caption = "The area under each curve is one.")
```


```{r}
ggplot(d, mapping = aes(x = resid, fill = cut))+
  geom_boxplot(aes(y = cut), alpha = 0.7) +
  scale_fill_manual(values = cut_colors) +
  labs(title = "Another plot showing the same thing")
```
