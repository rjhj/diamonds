---
title: "Diamonds"
author: "rjhj"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Diamond paradox

How can there be a negative correlation between the quality of the cut of a diamond and its price? This work explains this fascinating and educational puzzle.

Data set

Diamonds is a famous training data set with almost 54,000 observations. It comes with ggplot2, which is a part of tidyverse.

In this work I'll be using tidyverse techniques and philosophies mentioned in the "R for Data Science" book by Hadley Wickham (<https://r4ds.had.co.nz/>).

### 1. Preparation

```{r}
library(tidyverse)

cut_colors = c("#C76E32", "#A8A846", "#46A846",
               "#3584B8", "#555599")
```

Price of diamonds in this data set is capped at around \$18,000. Here are the top 3 most valuable for each quality of cut. The numbers are very similar.

```{r}
diamonds |>
  group_by(cut) |>
  slice_max(order_by = price, n = 3)
```

This ceiling can hide the real connection between the variables, so in analysis I'm going filter out some of the biggest diamonds (\>= 1.75). Ceiling will still affect the results, but at least a little bit less.

```{r}
d <- diamonds |>
  filter(carat < 1.75)

paste("Only", nrow(diamonds) - nrow(d), "rows were removed.")

```

```{r}
d |>
  group_by(cut) |>
  slice_max(order_by = price, n = 3)
```

## 2. Paradox

How does the quality of the cut affect the price of diamonds?

```{r}
ggplot(d, aes(price, after_stat(density), colour = cut)) +
  geom_freqpoly(binwidth = 500, size = 2) +
  scale_color_manual(values = cut_colors) +
  labs(title = "Surprise: Lower quality cut diamonds are more valuable?",
       caption = "The area under each curve is one.")
```

```{r}
ggplot(d, mapping = aes(x = price, fill = cut))+
  geom_boxplot(aes(y = cut), alpha = 0.7) +
  scale_fill_manual(values = cut_colors) +
  labs(title = "Another plot showing that fair diamonds are more valuable than the ideal")
```

## 3. Explanation

Lower quality cuts being more valuable can be explained by two other correlations.

```{r}
ggplot(d, aes(x = carat, y = after_stat(density))) +
  geom_freqpoly(aes(colour = cut), size = 2, bins = 20) +
  scale_color_manual(values = cut_colors) +
  labs(title = "Explanation 1:",
       subtitle= "Diamonds with lower quality cuts seem to be bigger",
       caption = "The area under each curve is one.")
```

```{r}
ggplot(d, aes(x = carat, y = price)) + 
  geom_boxplot(aes(group = cut_width(carat, 0.1)), alpha = 0.5) +
  labs(title = "Explanation 2:",
       subtitle= "Size and price are strongly correlated",
       caption = "")
```

Let's explore the relationship between carat and price more.

## 4.Relationships between size and price

```{r}
ggplot(d, aes(carat, price)) +
  geom_bin2d() +
  scale_fill_continuous(type = "viridis") +
  labs(title = "Relationship seems to be exponential")
```

```{r}
ggplot(d, aes(carat, price)) +
  geom_bin2d() +
  scale_fill_continuous(type = "viridis") +
  geom_smooth(formula = y ~ x, method = "lm", color = "white") +
  scale_x_log10() + 
  scale_y_log10() +
  labs(title = "Logarithmic scale fits the data well")
```

r^2^:

```{r}
model <- lm(log(price) ~ log(carat), d) 
paste0("Trying to fit linear model to the unmodified data gives R-squared of ",
      round(summary(lm(price ~ carat, d))$r.squared, 2),
      ", but the logarithmic data gives ",
      round(summary(model)$r.squared, 2),
      ".")
```

## 5. Removing the effect of size

Let's add a new column for residuals.

```{r}
d |>
  lm(model, data = _) |>
  add_residuals(d, model = _) |>
  mutate(resid = exp(resid)) -> d
```

Residuals here tell the difference between what the linear regression model
predicted and its actual value.

```{r}
paste0("The formula that linear model gives is ",
       round(summary(model)$coefficients[2], 2),
       " * log(carat) + ",
       round(summary(model)$coefficients[1], 2),
       " = log(price)")
```


